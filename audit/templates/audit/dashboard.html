{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>QA Tool Dashboard</title>
    <meta name="description" content="Monitor web quality assurance audits, download PDF reports, and manage SaaS subscriptions in one workspace.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/svg+xml" href="{% static 'audit/favicon.svg' %}">
    <style>
        :root { color-scheme: light; }
        body { font-family: "Inter", "Segoe UI", Arial, sans-serif; margin: 0; background: #f5f9ff; color: #0f172a; min-height: 100vh; display: flex; flex-direction: column; }
        .topbar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(6px); border-bottom: 1px solid rgba(15, 23, 42, 0.06); position: sticky; top: 0; z-index: 10; }
        .topbar .bar { max-width: 1100px; margin: 0 auto; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        .brand { font-weight: 700; font-size: 1.1rem; letter-spacing: -0.01em; color: #0f172a; text-decoration: none; display: inline-flex; align-items: center; gap: 0.35rem; }
        .brand span { display: inline-flex; align-items: center; justify-content: center; width: 2rem; height: 2rem; border-radius: 0.75rem; background: linear-gradient(135deg, #2d8cff, #60a5fa); color: #fff; font-size: 1rem; }
        .nav-actions { display: flex; align-items: center; flex-wrap: wrap; gap: 0.75rem; }
        .nav-link { font-weight: 600; color: #1d4ed8; text-decoration: none; padding: 0.45rem 0.75rem; border-radius: 999px; background: rgba(29, 78, 216, 0.08); transition: background 0.2s ease; }
        .nav-link:hover { background: rgba(29, 78, 216, 0.16); }
        .welcome { color: #475569; font-size: 0.95rem; }
        main.shell { flex: 1 0 auto; max-width: 1100px; width: 100%; margin: 0 auto; padding: 2.5rem 1.5rem 4rem; }
        header { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem; }
        header h1 { font-size: 2.5rem; margin: 0; letter-spacing: -0.03em; }
        header p { margin: 0; color: #475569; font-size: 1rem; }
        .actions { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .button { display: inline-flex; align-items: center; justify-content: center; padding: 0.7rem 1.4rem; border-radius: 999px; background: #2d8cff; color: #fff; font-weight: 600; text-decoration: none; border: none; cursor: pointer; transition: background 0.2s ease; }
        .button:hover { background: #1c6fd5; }
        .button.secondary { background: #0f172a; }
        .link-button { display: inline-flex; align-items: center; justify-content: center; padding: 0.45rem 0.9rem; border-radius: 999px; background: rgba(15, 23, 42, 0.08); color: #0f172a; font-weight: 600; text-decoration: none; transition: background 0.2s ease; }
        .link-button:hover { background: rgba(15, 23, 42, 0.16); }
        .messages { margin-bottom: 1.5rem; }
        .message { padding: 0.9rem 1.2rem; border-radius: 12px; margin-bottom: 0.75rem; font-weight: 500; }
        .message.success { background: rgba(34, 197, 94, 0.12); color: #15803d; }
        .message.warning { background: rgba(251, 191, 36, 0.16); color: #92400e; }
        .message.error { background: rgba(248, 113, 113, 0.16); color: #b91c1c; }
        form { background: #fff; padding: 1.75rem; border-radius: 18px; box-shadow: 0 8px 24px rgba(15, 23, 42, 0.09); margin-bottom: 2.5rem; display: grid; gap: 1rem; }
        form h2 { margin: 0; font-size: 1.35rem; position: relative; z-index: 1; }
        label { display: block; font-weight: 600; margin-bottom: 0.35rem; color: #1e293b; }
        select, input, textarea { width: 100%; padding: 0.8rem 0.9rem; border-radius: 10px; border: 1px solid #d6e0f0; background: rgba(248, 250, 252, 0.8); transition: border 0.2s ease, box-shadow 0.2s ease; }
        select:focus, input:focus, textarea:focus { border-color: #2d8cff; outline: none; box-shadow: 0 0 0 3px rgba(45, 140, 255, 0.2); }
        button[type="submit"] { justify-self: flex-start; position: relative; z-index: 1; }
        .muted { color: #64748b; font-size: 0.95rem; }
        .layout { display: grid; gap: 1.5rem; grid-template-columns: minmax(0, 2fr) minmax(0, 1fr); align-items: start; }
        .stack { display: grid; gap: 1.5rem; }
        .card { background: #fff; border-radius: 18px; padding: 1.75rem; box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08); position: relative; }
        .card h2, .card h3 { margin-top: 0; margin-bottom: 1rem; font-size: 1.25rem; }
        .summary { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-bottom: 1.25rem; }
        .summary h2 { margin: 0; font-size: 1.5rem; }
        .summary .status { padding: 0.35rem 0.9rem; border-radius: 999px; font-size: 0.8rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; background: rgba(45, 140, 255, 0.1); color: #1d4ed8; }
        .status.completed { background: rgba(34, 197, 94, 0.14); color: #047857; }
        .status.failed { background: rgba(248, 113, 113, 0.18); color: #b91c1c; }
        .summary .muted { margin-left: auto; }
        .grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); position: relative; z-index: 1; }
        .metric { background: linear-gradient(145deg, #f8fbff 0%, #edf4ff 100%); border-radius: 14px; padding: 1.1rem; }
        .metric strong { display: block; font-size: 0.85rem; letter-spacing: 0.08em; text-transform: uppercase; color: #475569; margin-bottom: 0.4rem; }
        .metric div { font-size: 1.5rem; font-weight: 700; color: #0f172a; }
        .metric:hover { background-color: #e5e7eb; }
        .table-wrapper { overflow-x: auto; border-radius: 16px; }
        table { width: 100%; border-collapse: collapse; position: relative; z-index: 1; min-width: 560px; }
        th, td { padding: 0.85rem 0.75rem; text-align: left; border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        th { font-size: 0.8rem; letter-spacing: 0.08em; text-transform: uppercase; color: #475569; background: rgba(15, 23, 42, 0.02); }
        tbody tr:hover { background: rgba(241, 245, 249, 0.6); }
        .tags { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; position: relative; z-index: 1; }
        .tag { padding: 0.35rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; color: #fff; box-shadow: 0 10px 18px rgba(15, 23, 42, 0.12); }
        .tag.low { background: #6366f1; }
        .tag.medium { background: #f97316; }
        .tag.high { background: #ef4444; }
        .subscription-card { display: grid; gap: 1rem; background: #f0f6ff; border-radius: 18px; padding: 1.4rem; color: #0f172a; border: 1px solid rgba(59,130,246,0.12); }
        .subscription-card .title { font-size: 1.05rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; }
        .subscription-meta { display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.9rem; color: #0f172a; }
        .quota { display: grid; gap: 0.5rem; }
        .progress-bar { height: 8px; border-radius: 999px; background: rgba(15, 23, 42, 0.15); overflow: hidden; }
        .progress-bar span { display: block; height: 100%; background: linear-gradient(90deg, #2d8cff, #60a5fa); width: calc(var(--usage, 0) * 1%); transition: width 0.3s ease; }
        .plan-grid { display: grid; gap: 1.2rem; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); position: relative; z-index: 1; }
        .plan { background: #fff; border-radius: 16px; padding: 1.4rem; box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08); display: grid; gap: 0.75rem; position: relative; }
        .plan h4 { margin: 0; font-size: 1.1rem; }
        .plan .price { font-size: 1.8rem; font-weight: 700; }
        .plan ul { margin: 0; padding-left: 1rem; color: #475569; display: grid; gap: 0.4rem; }
        .plan form { margin: 0; padding: 0; box-shadow: none; background: none; display: contents; }
        .plan button { width: 100%; }
        .empty { color: #94a3b8; font-style: italic; }
        footer { padding: 2rem 1.5rem 3rem; text-align: center; color: #94a3b8; font-size: 0.9rem; }
        @media (max-width: 900px) {
            .topbar .bar { padding: 0.85rem 1rem; }
            .nav-actions { justify-content: flex-end; }
            header h1 { font-size: 2rem; }
            .layout { grid-template-columns: 1fr; }
        }
        @media (max-width: 640px) {
            .topbar .bar { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .nav-actions { width: 100%; justify-content: space-between; }
            .nav-link { padding: 0.4rem 0.65rem; }
            header { text-align: left; }
        }
    </style>
</head>
<body>
    <nav class="topbar">
        <div class="bar">
            <a href="{% url 'audit-dashboard' %}" class="brand"><span>Q</span>QA Insights</a>
            <div class="nav-actions">
                <a href="{% url 'pricing' %}" class="nav-link">Pricing</a>
                {% if user.is_authenticated %}
                    <span class="welcome">Signed in as {{ user.get_short_name|default:user.username }}</span>
                    <a href="{% url 'logout' %}" class="nav-link">Sign out</a>
                {% else %}
                    <a href="{% url 'login' %}" class="nav-link">Sign in</a>
                    <a href="{% url 'signup' %}" class="button">Create account</a>
                {% endif %}
            </div>
        </div>
    </nav>
    <main class="shell">
        <header>
            <div>
                <h1>QA Insights Control Center</h1>
                <p>Deliver 99% accurate accessibility, SEO, and performance audits with instant PDF reports.</p>
            </div>
            <div class="actions">
                <a href="{% url 'pricing' %}" class="button">Upgrade subscription</a>
                {% if latest_audit %}
                    {% if user.is_staff or latest_audit.created_by_id == user.id %}
                        <a href="{% url 'audit-download' latest_audit.pk %}" class="button secondary">Download latest PDF</a>
                    {% endif %}
                {% endif %}
            </div>
        </header>

        <div class="messages">
            {% for message in messages %}
                <div class="message {{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>

        {% if subscription %}
            <section class="subscription-card">
                <div class="title">Current plan · {{ subscription.plan.name }}</div>
                <div class="subscription-meta">
                    <span>Status: {{ subscription.status|title }}</span>
                    {% if subscription.current_period_end %}
                        <span>Renews: {{ subscription.current_period_end|date:"M j, Y" }}</span>
                    {% else %}
                        <span>Renews: Lifetime access</span>
                    {% endif %}
                    <span>Accuracy: 99%</span>
                </div>
                {% if subscription.plan.audit_quota %}
                    <div class="quota">
                        <div>Audits used {{ subscription.audits_used }} / {{ subscription.plan.audit_quota }}</div>
                        <div class="progress-bar" style="--usage: {{ subscription_usage_percent|default_if_none:'0' }}">
                            <span></span>
                        </div>
                        <div class="muted">
                            Remaining: {{ remaining_audits }} audit{{ remaining_audits|pluralize }} ·
                            {{ subscription_usage_percent|default_if_none:0 }}% of plan used
                        </div>
                    </div>
                {% else %}
                    <div class="muted">Unlimited audits enabled.</div>
                {% endif %}
            </section>
        {% endif %}

        <form method="post">
            {% csrf_token %}
            <h2>Launch a precision-guided audit</h2>
            <label for="website_id">Choose saved website</label>
            <select name="website_id" id="website_id">
                <option value="">Select existing website</option>
                {% for site in websites %}
                    <option value="{{ site.id }}">{{ site.name|default:site.url }}</option>
                {% empty %}
                    <option value="" disabled>No saved websites yet.</option>
                {% endfor %}
            </select>
            <p class="muted">Or provide a new website URL and we will add it to your workspace automatically.</p>
            <label for="name">Website name</label>
            <input type="text" id="name" name="name" placeholder="My Website" />
            <label for="url">Website URL</label>
            <input type="url" id="url" name="url" placeholder="https://example.com" required />
            <button type="submit" class="button">Run audit</button>
        </form>

        <div class="layout">
            <div class="stack">
                {% if latest_audit %}
                    <section class="card">
                        <div class="summary">
                            <h2>{{ latest_audit.website.name|default:latest_audit.website.url }}</h2>
                            <span class="status {{ latest_audit.status }}">{{ latest_audit.status }}</span>
                            <span class="muted">{{ latest_audit.created_at|date:"M j, Y H:i" }}</span>
                        </div>
                        <p class="muted">{{ latest_audit.summary }}</p>
                        <div class="grid">
                            <div class="metric">
                                <strong>Score</strong>
                                <div>{{ latest_audit.score }}</div>
                            </div>
                            <div class="metric">
                                <strong>Response Time</strong>
                                <div>{{ latest_audit.response_time_ms }} ms</div>
                            </div>
                            <div class="metric">
                                <strong>Content Length</strong>
                                <div>{{ latest_audit.content_length }} bytes</div>
                            </div>
                            <div class="metric">
                                <strong>HTTP Status</strong>
                                <div>{{ latest_audit.metadata.status }}</div>
                            </div>
                        </div>
                    </section>

                    <section class="card">
                        <h3>Findings</h3>
                        {% if findings %}
                            <div class="tags">
                                {% for finding in findings %}
                                    <div class="tag {{ finding.severity }}">{{ finding.category }} – {{ finding.severity|title }}</div>
                                {% endfor %}
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Description</th>
                                        <th>Recommendation</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for finding in findings %}
                                        <tr>
                                            <td>{{ finding.title }}</td>
                                            <td>{{ finding.description }}</td>
                                            <td>{{ finding.recommendation }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p class="empty">No findings recorded for this audit.</p>
                        {% endif %}
                    </section>

                    <section class="card">
                        <h3>Metrics</h3>
                        {% if metrics %}
                            <div class="grid">
                                {% for metric in metrics %}
                                    <div class="metric">
                                        <strong>{{ metric.label }}</strong>
                                        <div>{{ metric.value }}</div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="empty">No metrics recorded.</p>
                        {% endif %}
                    </section>
                {% endif %}

                <section class="card">
                    <h3>Your recent audits</h3>
                    {% if user_recent_audits %}
                        <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Website</th>
                                    <th>Status</th>
                                    <th>Summary</th>
                                    <th>Created</th>
                                    <th>Report</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for audit in user_recent_audits %}
                                    <tr>
                                        <td>{{ audit.website.name|default:audit.website.url }}</td>
                                        <td>{{ audit.status }}</td>
                                        <td>{{ audit.summary }}</td>
                                        <td>{{ audit.created_at|date:"M j, Y H:i" }}</td>
                                        <td><a href="{% url 'audit-download' audit.pk %}" class="link-button">Download</a></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </div>
                    {% else %}
                        <p class="empty">Run your first audit to populate this feed.</p>
                    {% endif %}
                </section>
            </div>

            <section class="card">
                <h3>Plan accelerator</h3>
                <div class="plan-grid">
                    {% for plan in plans %}
                        <article class="plan">
                            <h4>{{ plan.name }}</h4>
                            <div class="muted">{{ plan.description }}</div>
                            <div class="price">{{ plan.display_price }}</div>
                            {% if plan.features %}
                                <ul>
                                    {% for feature in plan.features %}
                                        <li>{{ feature }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                            <form method="post" action="{% url 'checkout' plan.slug %}">
                                {% csrf_token %}
                                <button type="submit" class="button">Select {{ plan.name }}</button>
                            </form>
                        </article>
                    {% empty %}
                        <p class="empty">No public plans available yet.</p>
                    {% endfor %}
                </div>
            </section>
        </div>

        <section class="card">
            <h3>Global recent audits</h3>
            {% if recent_audits %}
                <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Website</th>
                            <th>Status</th>
                            <th>Summary</th>
                            <th>Created</th>
                            <th>Report</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for audit in recent_audits %}
                            <tr>
                                <td>{{ audit.website.name|default:audit.website.url }}</td>
                                <td>{{ audit.status }}</td>
                                <td>{{ audit.summary }}</td>
                                <td>{{ audit.created_at|date:"M j, Y H:i" }}</td>
                                <td>
                                    {% if user.is_staff or audit.created_by_id == user.id %}
                                        <a href="{% url 'audit-download' audit.pk %}" class="link-button">Download</a>
                                    {% else %}
                                        <span class="muted">Restricted</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            {% else %}
                <p class="empty">No audits have been run yet.</p>
            {% endif %}
        </section>
    </main>
    <footer>
        &copy; {% now "Y" %} QA Insights. All rights reserved.
    </footer>
</body>
</html>
