{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>QA Tool Dashboard</title>
    <meta name="description" content="Monitor web quality assurance audits, download PDF reports, and manage SaaS subscriptions in one workspace.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/svg+xml" href="{% static 'audit/favicon.svg' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2xN6YtF6Xn2zpOwVG55VnY0os1tLFp+M0ao0m2Q=" crossorigin="" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js" defer></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-VzL5H3pP4SzscgCN1vFeJEewB0g6w0tbGA2n9g3p+DQ=" crossorigin="" defer></script>
    <style>
        :root { color-scheme: light; }
        body { font-family: "Inter", "Segoe UI", Arial, sans-serif; margin: 0; background: #f5f9ff; color: #0f172a; min-height: 100vh; display: flex; flex-direction: column; }
        .topbar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(6px); border-bottom: 1px solid rgba(15, 23, 42, 0.06); position: sticky; top: 0; z-index: 10; }
        .topbar .bar { max-width: 1100px; margin: 0 auto; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        .brand { font-weight: 700; font-size: 1.1rem; letter-spacing: -0.01em; color: #0f172a; text-decoration: none; display: inline-flex; align-items: center; gap: 0.35rem; }
        .brand span { display: inline-flex; align-items: center; justify-content: center; width: 2rem; height: 2rem; border-radius: 0.75rem; background: linear-gradient(135deg, #2d8cff, #60a5fa); color: #fff; font-size: 1rem; }
        .nav-actions { display: flex; align-items: center; flex-wrap: wrap; gap: 0.75rem; }
        .nav-link { font-weight: 600; color: #1d4ed8; text-decoration: none; padding: 0.45rem 0.75rem; border-radius: 999px; background: rgba(29, 78, 216, 0.08); transition: background 0.2s ease; }
        .nav-link:hover { background: rgba(29, 78, 216, 0.16); }
        .welcome { color: #475569; font-size: 0.95rem; }
        main.shell { flex: 1 0 auto; max-width: 1100px; width: 100%; margin: 0 auto; padding: 2.5rem 1.5rem 4rem; }
        header { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem; }
        header h1 { font-size: 2.5rem; margin: 0; letter-spacing: -0.03em; }
        header p { margin: 0; color: #475569; font-size: 1rem; }
        .actions { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .button { display: inline-flex; align-items: center; justify-content: center; padding: 0.7rem 1.4rem; border-radius: 999px; background: #2d8cff; color: #fff; font-weight: 600; text-decoration: none; border: none; cursor: pointer; transition: background 0.2s ease; }
        .button:hover { background: #1c6fd5; }
        .button.secondary { background: #0f172a; }
        .link-button { display: inline-flex; align-items: center; justify-content: center; padding: 0.45rem 0.9rem; border-radius: 999px; background: rgba(15, 23, 42, 0.08); color: #0f172a; font-weight: 600; text-decoration: none; transition: background 0.2s ease; }
        .link-button:hover { background: rgba(15, 23, 42, 0.16); }
        .messages { margin-bottom: 1.5rem; }
        .message { padding: 0.9rem 1.2rem; border-radius: 12px; margin-bottom: 0.75rem; font-weight: 500; }
        .message.success { background: rgba(34, 197, 94, 0.12); color: #15803d; }
        .message.warning { background: rgba(251, 191, 36, 0.16); color: #92400e; }
        .message.error { background: rgba(248, 113, 113, 0.16); color: #b91c1c; }
        form { background: #fff; padding: 1.75rem; border-radius: 18px; box-shadow: 0 8px 24px rgba(15, 23, 42, 0.09); margin-bottom: 2.5rem; display: grid; gap: 1rem; }
        form h2 { margin: 0; font-size: 1.35rem; position: relative; z-index: 1; }
        label { display: block; font-weight: 600; margin-bottom: 0.35rem; color: #1e293b; }
        select, input, textarea { width: 100%; padding: 0.8rem 0.9rem; border-radius: 10px; border: 1px solid #d6e0f0; background: rgba(248, 250, 252, 0.8); transition: border 0.2s ease, box-shadow 0.2s ease; }
        select:focus, input:focus, textarea:focus { border-color: #2d8cff; outline: none; box-shadow: 0 0 0 3px rgba(45, 140, 255, 0.2); }
        button[type="submit"] { justify-self: flex-start; position: relative; z-index: 1; }
        .muted { color: #64748b; font-size: 0.95rem; }
        .analytics-grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-bottom: 2rem; }
        .analytics-card { background: linear-gradient(150deg, rgba(45,140,255,0.12), rgba(37,99,235,0.06)); border-radius: 16px; padding: 1.2rem; display: grid; gap: 0.5rem; border: 1px solid rgba(59,130,246,0.18); }
        .analytics-card h3 { margin: 0; font-size: 0.9rem; letter-spacing: 0.08em; text-transform: uppercase; color: #1d4ed8; }
        .analytics-card strong { font-size: 2rem; line-height: 1; }
        .analytics-card span { color: #475569; font-size: 0.95rem; }
        .data-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin-bottom: 2rem; }
        .data-card { background: #fff; border-radius: 18px; padding: 1.5rem; box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08); display: grid; gap: 1rem; position: relative; min-height: 180px; }
        .data-card h3 { margin: 0; font-size: 1.1rem; }
        .chart-wrapper { position: relative; width: 100%; height: 260px; }
        #audit-map { width: 100%; height: 300px; border-radius: 14px; }
        .layout { display: grid; gap: 1.5rem; grid-template-columns: minmax(0, 2fr) minmax(0, 1fr); align-items: start; }
        .stack { display: grid; gap: 1.5rem; }
        .card { background: #fff; border-radius: 18px; padding: 1.75rem; box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08); position: relative; }
        .card h2, .card h3 { margin-top: 0; margin-bottom: 1rem; font-size: 1.25rem; }
        .summary { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-bottom: 1.25rem; }
        .summary h2 { margin: 0; font-size: 1.5rem; }
        .summary .status { padding: 0.35rem 0.9rem; border-radius: 999px; font-size: 0.8rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; background: rgba(45, 140, 255, 0.1); color: #1d4ed8; }
        .status.completed { background: rgba(34, 197, 94, 0.14); color: #047857; }
        .status.failed { background: rgba(248, 113, 113, 0.18); color: #b91c1c; }
        .summary .muted { margin-left: auto; }
        .grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); position: relative; z-index: 1; }
        .metric { background: linear-gradient(145deg, #f8fbff 0%, #edf4ff 100%); border-radius: 14px; padding: 1.1rem; }
        .metric strong { display: block; font-size: 0.85rem; letter-spacing: 0.08em; text-transform: uppercase; color: #475569; margin-bottom: 0.4rem; }
        .metric div { font-size: 1.5rem; font-weight: 700; color: #0f172a; }
        .metric:hover { background-color: #e5e7eb; }
        .table-wrapper { overflow-x: auto; border-radius: 16px; }
        table { width: 100%; border-collapse: collapse; position: relative; z-index: 1; min-width: 560px; }
        th, td { padding: 0.85rem 0.75rem; text-align: left; border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        th { font-size: 0.8rem; letter-spacing: 0.08em; text-transform: uppercase; color: #475569; background: rgba(15, 23, 42, 0.02); }
        tbody tr:hover { background: rgba(241, 245, 249, 0.6); }
        .tags { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; position: relative; z-index: 1; }
        .tag { padding: 0.35rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; color: #fff; box-shadow: 0 10px 18px rgba(15, 23, 42, 0.12); }
        .tag.low { background: #6366f1; }
        .tag.medium { background: #f97316; }
        .tag.high { background: #ef4444; }
        .subscription-card { display: grid; gap: 1rem; background: #f0f6ff; border-radius: 18px; padding: 1.4rem; color: #0f172a; border: 1px solid rgba(59,130,246,0.12); }
        .subscription-card .title { font-size: 1.05rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; }
        .subscription-meta { display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.9rem; color: #0f172a; }
        .quota { display: grid; gap: 0.5rem; }
        .progress-bar { height: 8px; border-radius: 999px; background: rgba(15, 23, 42, 0.15); overflow: hidden; }
        .progress-bar span { display: block; height: 100%; background: linear-gradient(90deg, #2d8cff, #60a5fa); width: calc(var(--usage, 0) * 1%); transition: width 0.3s ease; }
        .plan-grid { display: grid; gap: 1.2rem; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); position: relative; z-index: 1; }
        .plan { background: #fff; border-radius: 16px; padding: 1.4rem; box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08); display: grid; gap: 0.75rem; position: relative; }
        .plan h4 { margin: 0; font-size: 1.1rem; }
        .plan .price { font-size: 1.8rem; font-weight: 700; }
        .plan ul { margin: 0; padding-left: 1rem; color: #475569; display: grid; gap: 0.4rem; }
        .plan form { margin: 0; padding: 0; box-shadow: none; background: none; display: contents; }
        .plan button { width: 100%; }
        .empty { color: #94a3b8; font-style: italic; }
        .velocity-card { display: grid; gap: 0.75rem; }
        .velocity-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: #64748b; flex-wrap: wrap; gap: 0.5rem; }
        .velocity-chart { position: relative; width: 100%; height: 220px; }
        .velocity-chart canvas { width: 100% !important; height: 220px !important; }
        .timeline { display: grid; gap: 1rem; position: relative; padding-left: 0.5rem; }
        .timeline::before { content: ""; position: absolute; left: 0.4rem; top: 0; bottom: 0; width: 2px; background: rgba(37, 99, 235, 0.2); }
        .timeline-entry { position: relative; padding-left: 1.8rem; }
        .timeline-entry::before { content: ""; position: absolute; left: 0.25rem; top: 0.4rem; width: 0.6rem; height: 0.6rem; border-radius: 50%; background: #2563eb; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.18); }
        .timeline-entry h4 { margin: 0; font-size: 0.95rem; }
        .timeline-entry span { display: block; color: #64748b; font-size: 0.85rem; }
        .revenue-card { display: grid; gap: 0.6rem; }
        .revenue-value { font-size: 2.4rem; font-weight: 700; }
        .suggestions { display: grid; gap: 0.75rem; }
        .suggestion-item { background: linear-gradient(145deg, #fdf7ed, #fff3eb); border-radius: 14px; padding: 1rem 1.2rem; border: 1px solid rgba(251, 191, 36, 0.25); display: flex; gap: 0.75rem; }
        .suggestion-item strong { color: #ca8a04; }
        .suggestion-item span { flex: 1 0 auto; }
        .region-list { display: grid; gap: 0.75rem; }
        .region-row { display: flex; justify-content: space-between; align-items: center; background: rgba(15, 23, 42, 0.04); border-radius: 12px; padding: 0.6rem 0.9rem; }
        .region-row span { font-weight: 600; }
        .modal-toggle { background: rgba(37, 99, 235, 0.12); color: #1d4ed8; border-radius: 12px; padding: 0.6rem 0.9rem; border: 1px solid rgba(37, 99, 235, 0.25); cursor: pointer; font-weight: 600; text-align: center; }
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.55); display: none; align-items: center; justify-content: center; padding: 2rem; z-index: 100; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; border-radius: 16px; max-width: 720px; width: 100%; padding: 2rem; display: grid; gap: 1.2rem; }
        .modal table { min-width: unset; }
        .close-modal { justify-self: flex-end; background: rgba(15, 23, 42, 0.08); border: none; padding: 0.4rem 0.8rem; border-radius: 8px; cursor: pointer; }
        .plan-badge { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.8rem; border-radius: 999px; background: rgba(37, 99, 235, 0.12); color: #1d4ed8; font-size: 0.85rem; }
        .footer-nav { margin-top: 1.5rem; display: flex; justify-content: center; flex-wrap: wrap; gap: 1rem; }
        .footer-nav a { color: #1d4ed8; font-weight: 600; text-decoration: none; }
        .footer-nav a:hover { text-decoration: underline; }
        footer { padding: 2rem 1.5rem 3rem; text-align: center; color: #94a3b8; font-size: 0.9rem; }
        @media (max-width: 900px) {
            .topbar .bar { padding: 0.85rem 1rem; }
            .nav-actions { justify-content: flex-end; }
            header h1 { font-size: 2rem; }
            .layout { grid-template-columns: 1fr; }
        }
        @media (max-width: 640px) {
            .topbar .bar { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .nav-actions { width: 100%; justify-content: space-between; }
            .nav-link { padding: 0.4rem 0.65rem; }
            header { text-align: left; }
            .data-grid { grid-template-columns: 1fr; }
            .suggestion-item { flex-direction: column; }
            .timeline-entry { padding-left: 1.3rem; }
            .timeline-entry::before { left: 0; }
        }
    </style>
</head>
<body>
    <nav class="topbar">
        <div class="bar">
            <a href="{% url 'audit-dashboard' %}" class="brand"><span>Q</span>QA Insights</a>
            <div class="nav-actions">
                <a href="#analytics" class="nav-link">Analytics</a>
                <a href="#recent" class="nav-link">Audits</a>
                <a href="#plans" class="nav-link">Plans</a>
                <a href="{% url 'pricing' %}" class="nav-link">Pricing</a>
                {% if user.is_authenticated %}
                    <span class="welcome">Signed in as {{ user.get_short_name|default:user.username }}</span>
                    <a href="{% url 'logout' %}" class="nav-link">Sign out</a>
                {% else %}
                    <a href="{% url 'login' %}" class="nav-link">Sign in</a>
                    <a href="{% url 'signup' %}" class="button">Create account</a>
                {% endif %}
            </div>
        </div>
    </nav>
    <main class="shell">
        <header>
            <div>
                <h1>QA Insights Control Center</h1>
                <p>Deliver 99% accurate accessibility, SEO, and performance audits with instant PDF reports.</p>
            </div>
            <div class="actions">
                <a href="{% url 'pricing' %}" class="button">Upgrade subscription</a>
                <span class="modal-toggle" data-modal="plan-modal">Compare plans</span>
                {% if latest_audit %}
                    {% if user.is_staff or latest_audit.created_by_id == user.id %}
                        <a href="{% url 'audit-download' latest_audit.pk %}" class="button secondary">Download latest PDF</a>
                    {% endif %}
                {% endif %}
            </div>
        </header>

        <div class="messages">
            {% for message in messages %}
                <div class="message {{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>

        <section class="analytics-grid" id="analytics">
            <article class="analytics-card">
                <h3>Total Audits</h3>
                <strong>{{ analytics_totals.total }}</strong>
                <span>{{ analytics_totals.completed }} completed · {{ analytics_totals.failed }} failed</span>
            </article>
            <article class="analytics-card">
                <h3>Completion Rate</h3>
                <strong>{{ analytics_totals.completion_rate }}%</strong>
                <span>Average score {{ analytics_totals.avg_score }}</span>
            </article>
            <article class="analytics-card">
                <h3>Response Time</h3>
                <strong>{{ analytics_totals.avg_response }} ms</strong>
                <span>Average across all audits</span>
            </article>
            {% if subscription and remaining_audits is not None %}
                <article class="analytics-card">
                    <h3>Quota Remaining</h3>
                    <strong>{{ remaining_audits }}</strong>
                    <span>{{ subscription.plan.name }} plan usage · {{ subscription_usage_percent|default_if_none:0 }}%</span>
                </article>
            {% endif %}
        </section>

        {% if subscription %}
            <section class="subscription-card">
                <div class="title">Current plan · {{ subscription.plan.name }}</div>
                <div class="subscription-meta">
                    <span>Status: {{ subscription.status|title }}</span>
                    {% if subscription.current_period_end %}
                        <span>Renews: {{ subscription.current_period_end|date:"M j, Y" }}</span>
                    {% else %}
                        <span>Renews: Lifetime access</span>
                    {% endif %}
                    <span>Accuracy: 99%</span>
                </div>
                {% if subscription.plan.audit_quota %}
                    <div class="quota">
                        <div>Audits used {{ subscription.audits_used }} / {{ subscription.plan.audit_quota }}</div>
                        <div class="progress-bar" style="--usage: {{ subscription_usage_percent|default_if_none:'0' }}">
                            <span></span>
                        </div>
                        <div class="muted">
                            Remaining: {{ remaining_audits }} audit{{ remaining_audits|pluralize }} ·
                            {{ subscription_usage_percent|default_if_none:0 }}% of plan used
                        </div>
                    </div>
                {% else %}
                    <div class="muted">Unlimited audits enabled.</div>
                {% endif %}
            </section>
        {% endif %}

        <form method="post">
            {% csrf_token %}
            <h2>Launch a precision-guided audit</h2>
            <label for="website_id">Choose saved website</label>
            <select name="website_id" id="website_id">
                <option value="">Select existing website</option>
                {% for site in websites %}
                    <option value="{{ site.id }}">{{ site.name|default:site.url }}</option>
                {% empty %}
                    <option value="" disabled>No saved websites yet.</option>
                {% endfor %}
            </select>
            <p class="muted">Or provide a new website URL and we will add it to your workspace automatically.</p>
            <label for="name">Website name</label>
            <input type="text" id="name" name="name" placeholder="My Website" />
            <label for="url">Website URL</label>
            <input type="url" id="url" name="url" placeholder="https://example.com" required />
            <button type="submit" class="button">Run audit</button>
        </form>

        <section class="data-grid">
            <article class="data-card">
                <h3>Status distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="statusChart"></canvas>
                </div>
            </article>
            <article class="data-card">
                <h3>Average score trend</h3>
                <div class="chart-wrapper">
                    <canvas id="trendChart"></canvas>
                </div>
            </article>
            <article class="data-card">
                <h3>Subscribers per plan</h3>
                <div class="chart-wrapper">
                    <canvas id="planChart"></canvas>
                </div>
            </article>
            <article class="data-card">
                <h3>Global audit footprint</h3>
                <div id="audit-map"></div>
            </article>
            <article class="data-card">
                <h3>Weekly audit velocity</h3>
                {% if audit_velocity %}
                    <div class="velocity-card">
                        <div class="velocity-meta">
                            <span>Last {{ audit_velocity|length }} weeks</span>
                            <span>Total audits: {{ analytics_totals.total }}</span>
                        </div>
                        <div class="velocity-chart"><canvas id="velocityChart"></canvas></div>
                    </div>
                {% else %}
                    <p class="empty">Run audits to build momentum.</p>
                {% endif %}
            </article>
            <article class="data-card">
                <h3>Revenue snapshot</h3>
                <div class="revenue-card">
                    <div class="revenue-value">${{ total_revenue|floatformat:2 }}</div>
                    <p class="muted">Sum of successful payments across all plans.</p>
                </div>
            </article>
            <article class="data-card">
                <h3>Smart suggestions</h3>
                <div class="suggestions">
                    {% for tip in smart_suggestions %}
                        <div class="suggestion-item">
                            <strong>Insight</strong>
                            <span>{{ tip }}</span>
                        </div>
                    {% endfor %}
                </div>
            </article>
            <article class="data-card">
                <h3>Regional footprint</h3>
                <div class="region-list">
                    {% for region in region_summary %}
                        <div class="region-row">
                            <span>{{ region.name }}</span>
                            <span>{{ region.count }} audits</span>
                        </div>
                    {% empty %}
                        <p class="empty">No geo data available.</p>
                    {% endfor %}
                </div>
            </article>
            <article class="data-card">
                <h3>Activity timeline</h3>
                {% if timeline_events %}
                    <div class="timeline">
                        {% for event in timeline_events %}
                            <div class="timeline-entry">
                                <h4>{{ event.label }}</h4>
                                <span>{{ event.timestamp|date:"M j, Y H:i" }} · {{ event.type|title }} · {{ event.meta }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty">Nothing to report yet.</p>
                {% endif %}
            </article>
        </section>

        <div class="layout" id="recent">
            <div class="stack">
                {% if latest_audit %}
                    <section class="card" id="plans">
                        <div class="summary">
                            <h2>{{ latest_audit.website.name|default:latest_audit.website.url }}</h2>
                            <span class="status {{ latest_audit.status }}">{{ latest_audit.status }}</span>
                            <span class="muted">{{ latest_audit.created_at|date:"M j, Y H:i" }}</span>
                        </div>
                        <p class="muted">{{ latest_audit.summary }}</p>
                        <div class="grid">
                            <div class="metric">
                                <strong>Score</strong>
                                <div>{{ latest_audit.score }}</div>
                            </div>
                            <div class="metric">
                                <strong>Response Time</strong>
                                <div>{{ latest_audit.response_time_ms }} ms</div>
                            </div>
                            <div class="metric">
                                <strong>Content Length</strong>
                                <div>{{ latest_audit.content_length }} bytes</div>
                            </div>
                            <div class="metric">
                                <strong>HTTP Status</strong>
                                <div>{{ latest_audit.metadata.status }}</div>
                            </div>
                        </div>
                    </section>

                    <section class="card">
                        <h3>Findings</h3>
                        {% if findings %}
                            <div class="tags">
                                {% for finding in findings %}
                                    <div class="tag {{ finding.severity }}">{{ finding.category }} – {{ finding.severity|title }}</div>
                                {% endfor %}
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Description</th>
                                        <th>Recommendation</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for finding in findings %}
                                        <tr>
                                            <td>{{ finding.title }}</td>
                                            <td>{{ finding.description }}</td>
                                            <td>{{ finding.recommendation }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p class="empty">No findings recorded for this audit.</p>
                        {% endif %}
                    </section>

                    <section class="card">
                        <h3>Metrics</h3>
                        {% if metrics %}
                            <div class="grid">
                                {% for metric in metrics %}
                                    <div class="metric">
                                        <strong>{{ metric.label }}</strong>
                                        <div>{{ metric.value }}</div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="empty">No metrics recorded.</p>
                        {% endif %}
                    </section>
                {% endif %}

                <section class="card">
                    <h3>Your recent audits</h3>
                    {% if user_recent_audits %}
                        <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Website</th>
                                    <th>Status</th>
                                    <th>Summary</th>
                                    <th>Created</th>
                                    <th>Report</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for audit in user_recent_audits %}
                                    <tr>
                                        <td>{{ audit.website.name|default:audit.website.url }}</td>
                                        <td>{{ audit.status }}</td>
                                        <td>{{ audit.summary }}</td>
                                        <td>{{ audit.created_at|date:"M j, Y H:i" }}</td>
                                        <td><a href="{% url 'audit-download' audit.pk %}" class="link-button">Download</a></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </div>
                    {% else %}
                        <p class="empty">Run your first audit to populate this feed.</p>
                    {% endif %}
                </section>
            </div>

            <section class="card">
                <h3>Plan accelerator</h3>
                <div class="plan-grid">
                    {% for plan in plans %}
                        <article class="plan">
                            <h4>{{ plan.name }}</h4>
                            <div class="muted">{{ plan.description }}</div>
                            <div class="price">{{ plan.display_price }}</div>
                            {% if plan.features %}
                                <ul>
                                    {% for feature in plan.features %}
                                        <li>{{ feature }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                            <form method="post" action="{% url 'checkout' plan.slug %}">
                                {% csrf_token %}
                                <button type="submit" class="button">Select {{ plan.name }}</button>
                            </form>
                        </article>
                    {% empty %}
                        <p class="empty">No public plans available yet.</p>
                    {% endfor %}
                </div>
            </section>
        </div>

        <section class="card">
            <h3>Global recent audits</h3>
            {% if recent_audits %}
                <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Website</th>
                            <th>Status</th>
                            <th>Summary</th>
                            <th>Created</th>
                            <th>Report</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for audit in recent_audits %}
                            <tr>
                                <td>{{ audit.website.name|default:audit.website.url }}</td>
                                <td>{{ audit.status }}</td>
                                <td>{{ audit.summary }}</td>
                                <td>{{ audit.created_at|date:"M j, Y H:i" }}</td>
                                <td>
                                    {% if user.is_staff or audit.created_by_id == user.id %}
                                        <a href="{% url 'audit-download' audit.pk %}" class="link-button">Download</a>
                                    {% else %}
                                        <span class="muted">Restricted</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            {% else %}
                <p class="empty">No audits have been run yet.</p>
            {% endif %}
        </section>
    </main>
    <footer>
        &copy; {% now "Y" %} QA Insights. All rights reserved.
        <div class="footer-nav">
            <a href="#analytics">Analytics</a>
            <a href="#recent">Audits</a>
            <a href="#plans">Plans</a>
            <a href="{% url 'pricing' %}">Pricing</a>
            <a href="mailto:support@qa-insights.io">Support</a>
        </div>
    </footer>

    {{ chart_status_counts|json_script:"status-data" }}
    {{ chart_score_series|json_script:"trend-data" }}
    {{ chart_plan_breakdown|json_script:"plan-data" }}
    {{ region_markers|json_script:"region-markers" }}
    {{ audit_velocity|json_script:"velocity-data" }}

    <div class="modal" id="plan-modal">
        <div class="modal-content">
            <button class="close-modal" data-modal-close>Close</button>
            <h2>Plan comparison</h2>
            {% if plans %}
                <div class="plan-badges">
                    {% for plan in plans %}
                        <span class="plan-badge">{{ plan.name }} · {{ plan.display_price }}</span>
                    {% endfor %}
                </div>
                <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Feature</th>
                            {% for plan in plans %}
                                <th>{{ plan.name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in plan_feature_matrix %}
                            <tr>
                                <td>{{ row.feature }}</td>
                                {% for item in row.plans %}
                                    <td>{{ item.available|yesno:"✔,✖" }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            {% else %}
                <p class="empty">No plans to compare right now.</p>
            {% endif %}
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const statusEl = document.getElementById("status-data");
            const trendEl = document.getElementById("trend-data");
            const planEl = document.getElementById("plan-data");
            const markersEl = document.getElementById("region-markers");
            const velocityEl = document.getElementById("velocity-data");
            const modal = document.getElementById("plan-modal");
            document.querySelectorAll(".modal-toggle").forEach(button => {
                button.addEventListener("click", () => {
                    if (modal) modal.classList.add("active");
                });
            });
            document.querySelectorAll("[data-modal-close]").forEach(button => {
                button.addEventListener("click", () => {
                    if (modal) modal.classList.remove("active");
                });
            });
            if (modal) {
                modal.addEventListener("click", (event) => {
                    if (event.target === modal) modal.classList.remove("active");
                });
            }

            if (velocityEl) {
                const velocityData = JSON.parse(velocityEl.textContent || "[]");
                const ctx = document.getElementById("velocityChart");
                if (ctx && window.Chart && velocityData.length) {
                    new Chart(ctx, {
                        type: "line",
                        data: {
                            labels: velocityData.map(item => item.week),
                            datasets: [
                                {
                                    label: "Audits",
                                    data: velocityData.map(item => item.count),
                                    tension: 0.35,
                                    fill: true,
                                    backgroundColor: "rgba(37, 99, 235, 0.18)",
                                    borderColor: "rgba(37, 99, 235, 0.9)",
                                    pointRadius: 4,
                                    pointBackgroundColor: "#1d4ed8",
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${context.parsed.y} audits`,
                                    },
                                },
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { precision: 0 },
                                    grid: { color: "rgba(148, 163, 184, 0.2)" },
                                },
                                x: {
                                    grid: { display: false },
                                },
                            },
                        },
                    });
                }
            }

            if (statusEl) {
                const statusData = JSON.parse(statusEl.textContent || "[]");
                const ctx = document.getElementById("statusChart");
                if (ctx && window.Chart) {
                    new Chart(ctx, {
                        type: "bar",
                        data: {
                            labels: statusData.map(item => item.status),
                            datasets: [
                                {
                                    label: "Audits",
                                    data: statusData.map(item => item.count),
                                    backgroundColor: ["#22c55e", "#f97316", "#ef4444"],
                                    borderRadius: 12,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, ticks: { precision: 0 } },
                            },
                        },
                    });
                }
            }

            if (trendEl) {
                const trendData = JSON.parse(trendEl.textContent || "[]");
                const ctx = document.getElementById("trendChart");
                if (ctx && window.Chart) {
                    new Chart(ctx, {
                        type: "line",
                        data: {
                            labels: trendData.map(item => item.timestamp),
                            datasets: [
                                {
                                    label: "Score",
                                    data: trendData.map(item => item.score),
                                    borderColor: "#2563eb",
                                    backgroundColor: "rgba(37,99,235,0.2)",
                                    tension: 0.35,
                                    fill: true,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { suggestedMin: 0, suggestedMax: 100 },
                            },
                        },
                    });
                }
            }

            if (planEl) {
                const planData = JSON.parse(planEl.textContent || "[]");
                const ctx = document.getElementById("planChart");
                if (ctx && window.Chart) {
                    new Chart(ctx, {
                        type: "doughnut",
                        data: {
                            labels: planData.map(item => item.name),
                            datasets: [
                                {
                                    data: planData.map(item => item.count),
                                    backgroundColor: ["#1d4ed8", "#60a5fa", "#9333ea", "#f97316"],
                                    borderWidth: 0,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: "bottom" },
                            },
                        },
                    });
                }
            }

            if (markersEl) {
                const markerData = JSON.parse(markersEl.textContent || "[]");
                const mapEl = document.getElementById("audit-map");
                if (mapEl && window.L) {
                    const map = L.map("audit-map", { zoomControl: false }).setView([20, 0], 2);
                    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                        attribution: "&copy; OpenStreetMap contributors",
                    }).addTo(map);
                    markerData.forEach(marker => {
                        const popup = `<strong>${marker.name}</strong><br/>Audits: ${marker.count}`;
                        L.circleMarker(marker.coords, {
                            radius: 8 + marker.count,
                            weight: 1,
                            color: "#1d4ed8",
                            fillColor: "#3b82f6",
                            fillOpacity: 0.65,
                        }).addTo(map).bindPopup(popup);
                    });
                }
            }
        });
    </script>
</body>
</html>
